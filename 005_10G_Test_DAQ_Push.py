# https://sentry.io/answers/print-colored-text-to-terminal-with-python/




# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Import
# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
import socket
import binascii
import time



# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Constants
# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
NumberOfASIC = 2
SocketTimeOut = 5

NrOfPacket = 1
NrOfPushCycle = 4

ASIC_SELECT  = 3

ASIC0_IODly  = 32
ASIC1_IODly  = 32
ASIC2_IODly  = 0
ASIC3_IODly  = 0
ASIC4_IODly  = 0
ASIC5_IODly  = 0
ASIC6_IODly  = 0
ASIC7_IODly  = 0




# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Global Things
# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
HOST   ="10.1.2.207"
UDP_IP ="10.1.2.208"
PORT   =11000


# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Start...
# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
print("")
print("-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------")
print(">>>                                                         Test Script for DAQ Manual Push - 005_10G_Test_DAQ_Push.py                                                                                                                        <<<")
print("-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------")
print("")

RED     = '\033[31m'
GREEN   = '\033[32m'
YELLOW  = '\033[33m'
BLUE    = '\033[34m'
MAGENTA = '\033[35m'
CYAN    = '\033[36m'
WHITE   = '\033[37m'
RESET   = '\033[0m' # called to return to standard terminal text color




# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Socket Init...
# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM , 0)
s.bind((HOST,PORT))

s.settimeout(SocketTimeOut) # Sets the socket to timeout after "SocketTimeOut" second of no activity




# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# GetStatus, Check the communication
# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Position:       -6   -5   -4   -3   -2   -1   00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
# Position:      [   UDP COUNTER   ]  IP  PORT  00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
MesGetStatus   =[0x00,0x00,0x00,0x00,0x00,0x00,0xa0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x02,0x03,0x04]

print("Get Status: (FPGA Communication)")
# print("Position:   -6   -5   -4   -3   -2   -1   00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
# print("Position:   [   UDP COUNTER   ]  IP  PORT   00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
print("Position:   [   UDP COUNTER   ]  IP  PORT  " + MAGENTA + "HDR FPGA COMM" + RESET + "   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")


s.sendto(bytes(MesGetStatus), (UDP_IP, PORT))
data, add = s.recvfrom(1024)

hex_string = binascii.hexlify(data).decode('utf-8')
hex_string2 = r" 0x" + r" 0x".join(hex_string[n : n+2] for n in range(0, len(hex_string), 2))

tr_pre  = hex_string2[0:30]
tr_hdr  = MAGENTA + hex_string2[30:45] + RESET
tr_post = hex_string2[45:]
    
print("Status:    %s%s%s" % (tr_pre, tr_hdr, tr_post))
# print("Status:    %s" % (hex_string2))
print("")

time.sleep(0.5)




# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Read I2C Top Register
#
# Read All (NumberOfASIC) ASIC Top Registers...
# Sub-block address -> Top: 0d45
# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Position:       -6   -5   -4   -3   -2   -1   00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
# Position:      [   UDP COUNTER   ]  IP  PORT  00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
MesReadI2CTop  =[0x00,0x00,0x00,0x00,0x00,0x00,0xa0,0x00,0x10,0x00,0x00,0x95,0x05,0xa0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]

print("Read I2C Top Register:")
# print("Position:   -6   -5   -4   -3   -2   -1   00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
# print("Position:   [   UDP COUNTER   ]  IP  PORT  HDR   01   02   03   04   05   06   07  RUN   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
print("Position:   [   UDP COUNTER   ]  IP  PORT  " + MAGENTA + "HDR FPGA COMM" + RESET + "   03   04   05   06   07  " + CYAN + "RUN" + RESET + "   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")



for i in range (NumberOfASIC):
    MesReadI2CTop[6] = 160+i

    s.sendto(bytes(MesReadI2CTop), (UDP_IP, PORT))
    data, add = s.recvfrom(1024)
    
    hex_string = binascii.hexlify(data).decode('utf-8')
    hex_string2 = r" 0x" + r" 0x".join(hex_string[n : n+2] for n in range(0, len(hex_string), 2))

    tr_pre  = hex_string2[0:30]
    tr_hdr  = MAGENTA + hex_string2[30:45] + RESET
    tr_mid  = hex_string2[45:70]
    tr_run  = CYAN + hex_string2[70:75] + RESET
    tr_post = hex_string2[75:]
    
    print("Status (%s):%s%s%s%s%s" % (i, tr_pre, tr_hdr, tr_mid, tr_run, tr_post))
    # print("Status (%s):%s" % (i, hex_string2))

print("")
    
time.sleep(0.5)




# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Write START I2C
# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Position:       -6   -5   -4   -3   -2   -1   00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
# Position:      [   UDP COUNTER   ]  IP  PORT  00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
CFG_Top        =[0x00,0x00,0x00,0x00,0x00,0x00,0xa0,0x00,0x11,0x00,0x00,0x08,0x05,0xa0,0x0B,0x0f,0x40,0x7f,0x00,0x07,0x85,0x00,0xff,0x00,0xff,0x00,0xff,0x00,0x7f,0x00,0x11,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]


for i in range (NumberOfASIC):
    CFG_Top[6] = 160+i

    s.sendto(bytes(CFG_Top), (UDP_IP, PORT))
    
print("I2C Start -> Set “Top sub-block” I2C parameters -" + CYAN + "Register # 0  RunL/RunR to '1' (Should be 0x0b)" + RESET)
print("")
  
time.sleep(0.5)




# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Read I2C Top Register
#
# Read All (NumberOfASIC) ASIC Top Registers...
# Sub-block address -> Top: 0d45
# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Position:       -6   -5   -4   -3   -2   -1   00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
# Position:      [   UDP COUNTER   ]  IP  PORT  00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
MesReadI2CTop  =[0x00,0x00,0x00,0x00,0x00,0x00,0xa0,0x00,0x10,0x00,0x00,0x95,0x05,0xa0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]

print("Read I2C Top Register:")
# print("Position:   -6   -5   -4   -3   -2   -1   00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
# print("Position:   [   UDP COUNTER   ]  IP  PORT  HDR   01   02   03   04   05   06   07  RUN   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
print("Position:   [   UDP COUNTER   ]  IP  PORT  " + MAGENTA + "HDR FPGA COMM" + RESET + "   03   04   05   06   07  " + CYAN + "RUN" + RESET + "   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")



for i in range (NumberOfASIC):
    MesReadI2CTop[6] = 160+i

    s.sendto(bytes(MesReadI2CTop), (UDP_IP, PORT))
    data, add = s.recvfrom(1024)
    
    hex_string = binascii.hexlify(data).decode('utf-8')
    hex_string2 = r" 0x" + r" 0x".join(hex_string[n : n+2] for n in range(0, len(hex_string), 2))

    tr_pre  = hex_string2[0:30]
    tr_hdr  = MAGENTA + hex_string2[30:45] + RESET
    tr_mid  = hex_string2[45:70]
    tr_run  = CYAN + hex_string2[70:75] + RESET
    tr_post = hex_string2[75:]
    
    print("Status (%s):%s%s%s%s%s" % (i, tr_pre, tr_hdr, tr_mid, tr_run, tr_post))
    # print("Status (%s):%s" % (i, hex_string2))

print("")
    
time.sleep(0.5)




# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# DAQ Generator Parameter Read
# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Position:       -6   -5   -4   -3   -2   -1   00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
# Position:      [   UDP COUNTER   ]  IP  PORT  00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
MesReadGenPar  =[0x00,0x00,0x00,0x00,0x00,0x00,0xa0,0x00,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]

print("Read DAQ (Generator) Parameters:")
# print("Position:   -6   -5   -4   -3   -2   -1   00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
print("Position:   [   UDP COUNTER   ]  IP  PORT  " + MAGENTA + "HDR FPGA COMM" + RESET + "   03   04  " + CYAN + "GEN  DAQ" + RESET + "   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")


for i in range (NumberOfASIC):
    MesReadGenPar[6] = 160+i

    s.sendto(bytes(MesReadGenPar), (UDP_IP, PORT))
    data, add = s.recvfrom(1024)
    
    hex_string = binascii.hexlify(data).decode('utf-8')
    hex_string2 = r" 0x" + r" 0x".join(hex_string[n : n+2] for n in range(0, len(hex_string), 2))
    
    tr_pre  = hex_string2[0:30]
    tr_hdr  = MAGENTA + hex_string2[30:45] + RESET
    tr_mid  = hex_string2[45:55]
    tr_run  = CYAN + hex_string2[55:65] + RESET
    tr_post = hex_string2[65:]
    
    print("Status (%s):%s%s%s%s%s" % (i, tr_pre, tr_hdr, tr_mid, tr_run, tr_post))
    # print("Status (%s):%s" % (i, hex_string2))

print("")
    
time.sleep(0.5)




# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# SET DAQ
# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Position:       -6   -5   -4   -3   -2   -1   00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
# Position:      [   UDP COUNTER   ]  IP  PORT  00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
CFG_DAQ        =[0x00,0x00,0x00,0x00,0x00,0x00,0xa0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]

CFG_DAQ[6+2]  = 0x07  # Set Command ID - DAQ + GENERATOR PARAMETER Write - FPGA - Request
CFG_DAQ[6+3]  = 0x03  # Enable Data Collection on Data
CFG_DAQ[6+4]  = 0x00  # Disable Data Collection on Trigger

CFG_DAQ[6+7]  = 0x4B  # DAQ FCMD - L1A
CFG_DAQ[6+8]  = 0x4B  # GEN PRE FCMD - L1A
CFG_DAQ[6+9]  = 0x4B  # GEN FCMD - L1A

CFG_DAQ[6+10] = 0x00  # b0 - EXT. TRIG ENABLE
CFG_DAQ[6+11] = 0x00  # EXT. TRIG DELAY 7:0

CFG_DAQ[6+13] = 0x00  # b0 - GENERATOR PREIMP. ENABLE

CFG_DAQ[6+14] = 0x00  # GENERATOR PRE INTERVAL 15:0
CFG_DAQ[6+15] = 0x00  # GENERATOR PRE INTERVAL  7:0

CFG_DAQ[6+16] = 0x00  # GENERATOR NR OF CYCLE 31:24
CFG_DAQ[6+17] = 0x00  # GENERATOR NR OF CYCLE 23:16
CFG_DAQ[6+18] = 0x00  # GENERATOR NR OF CYCLE 15: 8
CFG_DAQ[6+19] = 0x00  # GENERATOR NR OF CYCLE  7: 0

CFG_DAQ[6+20] = 0x00  # GENERATOR INTERVAL 31:24
CFG_DAQ[6+21] = 0x00  # GENERATOR INTERVAL 23:16
CFG_DAQ[6+22] = 0x00  # GENERATOR INTERVAL 15: 8
CFG_DAQ[6+23] = 0x00  # GENERATOR INTERVAL  7: 0

CFG_DAQ[6+24] = 0x4B  # DAQ Push FCMD - L1A

CFG_DAQ[6+25] = 0x00  # MACHINE_GUN 7:0

CFG_DAQ[6+26] = 0x00  # EXT. TRIG DEADTIME 15:8
CFG_DAQ[6+27] = 0x00  # EXT. TRIG DEADTIME  7:0

CFG_DAQ[6+28] = 0x00  # EXT. TRIG OUT 0 - Length in CLK - 7:0
CFG_DAQ[6+29] = 0x00  # EXT. TRIG OUT 1 - Length in CLK - 7:0
CFG_DAQ[6+30] = 0x00  # EXT. TRIG OUT 2 - Length in CLK - 7:0
CFG_DAQ[6+31] = 0x00  # EXT. TRIG OUT 3 - Length in CLK - 7:0

s.sendto(bytes(CFG_DAQ), (UDP_IP, PORT))
    
print("Config DAQ...")
print("")
  
time.sleep(0.5)




# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# START DAQ
# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Position:       -6   -5   -4   -3   -2   -1   00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
# Position:      [   UDP COUNTER   ]  IP  PORT  00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
CFG_DAQ        =[0x00,0x00,0x00,0x00,0x00,0x00,0xa0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]

CFG_DAQ[6+2]  = 0x09  # DAQ + GENERATOR START/STOP -
CFG_DAQ[6+4]  = 0x00  # DAQ PUSH - ASIC7:ASIC0
CFG_DAQ[6+5]  = 0x00  # b0 - GENERATOR START/STOP
CFG_DAQ[6+6]  = 0x03  # DAQ START/STOP - ASIC7:ASIC0

s.sendto(bytes(CFG_DAQ), (UDP_IP, PORT))
    
print("Start DAQ...")
print("")
  
time.sleep(0.5)




# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# DAQ Generator Parameter Read
# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Position:       -6   -5   -4   -3   -2   -1   00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
# Position:      [   UDP COUNTER   ]  IP  PORT  00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
MesReadGenPar  =[0x00,0x00,0x00,0x00,0x00,0x00,0xa0,0x00,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]

print("Read DAQ (Generator) Parameters:")
# print("Position:   -6   -5   -4   -3   -2   -1   00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
print("Position:   [   UDP COUNTER   ]  IP  PORT  " + MAGENTA + "HDR FPGA COMM" + RESET + "   03   04  " + CYAN + "GEN  DAQ" + RESET + "   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")


for i in range (NumberOfASIC):
    MesReadGenPar[6] = 160+i

    s.sendto(bytes(MesReadGenPar), (UDP_IP, PORT))
    data, add = s.recvfrom(1024)
    
    hex_string = binascii.hexlify(data).decode('utf-8')
    hex_string2 = r" 0x" + r" 0x".join(hex_string[n : n+2] for n in range(0, len(hex_string), 2))
    
    tr_pre  = hex_string2[0:30]
    tr_hdr  = MAGENTA + hex_string2[30:45] + RESET
    tr_mid  = hex_string2[45:55]
    tr_run  = CYAN + hex_string2[55:65] + RESET
    tr_post = hex_string2[65:]
    
    print("Status (%s):%s%s%s%s%s" % (i, tr_pre, tr_hdr, tr_mid, tr_run, tr_post))
    # print("Status (%s):%s" % (i, hex_string2))

print("")
    
time.sleep(0.5)





 

# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Data parsing
# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
def data_parse(intext):
    
    intext = intext.replace(" ", "")
    intext = intext.upper()

    tr_udp_hdr = CYAN +"UDP PACKET COUNTER: " +  intext[0:8] + RESET + " " + intext[8:10] + " " + intext[10:12] +  RESET
    tr_rfu     = MAGENTA + intext[12:28] + RESET
    print(tr_udp_hdr + " - " + tr_rfu)
    print()

    tr_pack    = intext[28:412]
    # print(tr_pack)
    i = 0

    if (tr_pack[0:4] == "AA5A") :
    
        while tr_pack[0:4] == "AA5A" :
    
            tr_pack_hdr    = CYAN + tr_pack[0:4] + RESET
            tr_pack_faddr  = tr_pack[4:6] + RESET
            tr_pack_comm   = tr_pack[6:8] + RESET
    
            tr_pack_trin   = tr_pack[8:16] + RESET
            tr_pack_trout  = tr_pack[16:24] + RESET
            tr_pack_event  = tr_pack[24:32] + RESET
            tr_pack_ts     = CYAN + "TS:" + tr_pack[32:48] + RESET
            tr_pack_spare  = tr_pack[48:64] + RESET
    
            # print(tr_pack_hdr)
            # print(tr_pack_faddr)
            # print(tr_pack_comm)
            # print(tr_pack_trin)
            # print(tr_pack_trout)
            # print(tr_pack_event)
            # print(tr_pack_ts)
            # print(tr_pack_spare)
    
            str_pre = tr_pack_hdr + " " + tr_pack_faddr + " " + tr_pack_comm + " " + tr_pack_trin + " " + tr_pack_trout + " " + tr_pack_event + " " + tr_pack_ts + " " + tr_pack_spare
            print(str_pre)
    
            str_data = ""
            for j in range(40):
                str_temp = (tr_pack[64+j*8:72+j*8]) + " "
    
                if (j==0 or j==1 or j==20 or j==39) :
                    str_temp = CYAN + str_temp + RESET
    
                str_data = str_data + str_temp
    
            print(str_data)
            # print(str_data[0:198])
            # print(str_data[198:])
    
    
            i = i +1
            tr_pack    = intext[i*384+28:i*384+412]

            print()

    else:
        print (RED + "WRONG PACKET" + RESET)
        print()
    return
 


# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# DAQ Push and Receive
# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

print("")
print("")
print("")

# Position:       -6   -5   -4   -3   -2   -1   00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
# Position:      [   UDP COUNTER   ]  IP  PORT  00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
CFG_DAQ        =[0x00,0x00,0x00,0x00,0x00,0x00,0xa0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]

CFG_DAQ[6+2]  = 0x09  # DAQ + GENERATOR START/STOP -
CFG_DAQ[6+4]  = 0x03  # DAQ PUSH - ASIC7:ASIC0
CFG_DAQ[6+5]  = 0x00  # b0 - GENERATOR START/STOP
CFG_DAQ[6+6]  = 0x03  # DAQ START/STOP - ASIC7:ASIC0


for i in range (NrOfPushCycle):

    print("DAQ Push Sent... - %s/%s" % (NrOfPushCycle,i+1))
    
    s.sendto(bytes(CFG_DAQ), (UDP_IP, PORT))
    
    packcnt = 0
    print("DAQ Push >> Data:")
    while packcnt < NrOfPacket:
        data, add = s.recvfrom(8192)
        convert = bytes.hex(data)
        dataformat = [convert[i:i+2] for i in range(0, len(convert), 2)]

        data_parse(str(' '.join(dataformat)))
        # print(str(' '.join(dataformat)))

        packcnt = packcnt +1 
    
    print("")

print("")
print("")
print("")




# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Write STOP I2C
# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Position:       -6   -5   -4   -3   -2   -1   00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
# Position:      [   UDP COUNTER   ]  IP  PORT  00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
CFG_Top        =[0x00,0x00,0x00,0x00,0x00,0x00,0xa0,0x00,0x11,0x00,0x00,0x08,0x05,0xa0,0x08,0x0f,0x40,0x7f,0x00,0x07,0x85,0x00,0xff,0x00,0xff,0x00,0xff,0x00,0x7f,0x00,0x11,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]

for i in range (NumberOfASIC):
    CFG_Top[6] = 160+i

    s.sendto(bytes(CFG_Top), (UDP_IP, PORT))

print("I2C Start -> Set “Top sub-block” I2C parameters -" + CYAN + "Register # 0  RunL/RunR to '0' (Should be 0x08)" + RESET)
print("")

time.sleep(0.5)




# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Read I2C Top Register
#
# Read All (NumberOfASIC) ASIC Top Registers...
# Sub-block address -> Top: 0d45
# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Position:       -6   -5   -4   -3   -2   -1   00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
# Position:      [   UDP COUNTER   ]  IP  PORT  00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
MesReadI2CTop  =[0x00,0x00,0x00,0x00,0x00,0x00,0xa0,0x00,0x10,0x00,0x00,0x95,0x05,0xa0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]

print("Read I2C Top Register:")
# print("Position:   -6   -5   -4   -3   -2   -1   00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
# print("Position:   [   UDP COUNTER   ]  IP  PORT  HDR   01   02   03   04   05   06   07  RUN   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
print("Position:   [   UDP COUNTER   ]  IP  PORT  " + MAGENTA + "HDR FPGA COMM" + RESET + "   03   04   05   06   07  " + CYAN + "RUN" + RESET + "   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")



for i in range (NumberOfASIC):
    MesReadI2CTop[6] = 160+i

    s.sendto(bytes(MesReadI2CTop), (UDP_IP, PORT))
    data, add = s.recvfrom(1024)
    
    hex_string = binascii.hexlify(data).decode('utf-8')
    hex_string2 = r" 0x" + r" 0x".join(hex_string[n : n+2] for n in range(0, len(hex_string), 2))

    tr_pre  = hex_string2[0:30]
    tr_hdr  = MAGENTA + hex_string2[30:45] + RESET
    tr_mid  = hex_string2[45:70]
    tr_run  = CYAN + hex_string2[70:75] + RESET
    tr_post = hex_string2[75:]
    
    print("Status (%s):%s%s%s%s%s" % (i, tr_pre, tr_hdr, tr_mid, tr_run, tr_post))
    # print("Status (%s):%s" % (i, hex_string2))

print("")
    
time.sleep(0.5)




# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# STOP DAQ
# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Position:       -6   -5   -4   -3   -2   -1   00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
# Position:      [   UDP COUNTER   ]  IP  PORT  00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
CFG_DAQ        =[0x00,0x00,0x00,0x00,0x00,0x00,0xa0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]

CFG_DAQ[6+2]  = 0x09  # DAQ + GENERATOR START/STOP -
CFG_DAQ[6+4]  = 0x00  # DAQ PUSH - ASIC7:ASIC0
CFG_DAQ[6+5]  = 0x00  # b0 - GENERATOR START/STOP
CFG_DAQ[6+6]  = 0x00  # DAQ START/STOP - ASIC7:ASIC0

s.sendto(bytes(CFG_DAQ), (UDP_IP, PORT))
    
print("Stop DAQ...")
print("")
  
time.sleep(0.5)




# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# DAQ Generator Parameter Read
# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Position:       -6   -5   -4   -3   -2   -1   00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
# Position:      [   UDP COUNTER   ]  IP  PORT  00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
MesReadGenPar  =[0x00,0x00,0x00,0x00,0x00,0x00,0xa0,0x00,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]

print("Read DAQ (Generator) Parameters:")
# print("Position:   -6   -5   -4   -3   -2   -1   00   01   02   03   04   05   06   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")
print("Position:   [   UDP COUNTER   ]  IP  PORT  " + MAGENTA + "HDR FPGA COMM" + RESET + "   03   04  " + CYAN + "GEN  DAQ" + RESET + "   07   08   09   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39")


for i in range (NumberOfASIC):
    MesReadGenPar[6] = 160+i

    s.sendto(bytes(MesReadGenPar), (UDP_IP, PORT))
    data, add = s.recvfrom(1024)
    
    hex_string = binascii.hexlify(data).decode('utf-8')
    hex_string2 = r" 0x" + r" 0x".join(hex_string[n : n+2] for n in range(0, len(hex_string), 2))
    
    tr_pre  = hex_string2[0:30]
    tr_hdr  = MAGENTA + hex_string2[30:45] + RESET
    tr_mid  = hex_string2[45:55]
    tr_run  = CYAN + hex_string2[55:65] + RESET
    tr_post = hex_string2[65:]
    
    print("Status (%s):%s%s%s%s%s" % (i, tr_pre, tr_hdr, tr_mid, tr_run, tr_post))
    # print("Status (%s):%s" % (i, hex_string2))

print("")
    
time.sleep(0.5)




# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Close
# -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
s.close()

print("")
print(" >>> END <<<")
print("")

